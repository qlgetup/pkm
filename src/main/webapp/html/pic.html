<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Director | Dashboard</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <meta name="description" content="Developed By M Abdur Rokib Promy">
    <meta name="keywords" content="Admin, Bootstrap 3, Template, Theme, Responsive">
    <!-- bootstrap 3.0.2 -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <link href="css/ionicons.min.css" rel="stylesheet" type="text/css" />
    <!-- Morris chart -->
    <link href="css/morris/morris.css" rel="stylesheet" type="text/css" />
    <!-- jvectormap -->
    <link href="css/jvectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css" />
    <!-- Date Picker -->
    <link href="css/datepicker/datepicker3.css" rel="stylesheet" type="text/css" />
    <!-- fullCalendar -->
    <!-- <link href="css/fullcalendar/fullcalendar.css" rel="stylesheet" type="text/css" /> -->
    <!-- Daterange picker -->
    <link href="css/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css" />
    <!-- iCheck for checkboxes and radio inputs -->
    <link href="css/iCheck/all.css" rel="stylesheet" type="text/css" />
    <!-- bootstrap wysihtml5 - text editor -->
    <!-- <link href="css/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css" /> -->
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <!-- Theme style -->
    <link href="css/style.css" rel="stylesheet" type="text/css" />

</head>
<body class="skin-black">
<!-- header logo: style can be found in header.less -->
<header class="header">
    <a href="index.html" class="logo">
        <!-- Add the class icon to your logo image or logo icon to add the margining -->
        PKM
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top" role="navigation">
        <!-- Sidebar toggle button-->
        <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>
        <div class="navbar-right">
            <ul class="nav navbar-nav">
                <!-- User Account: style can be found in dropdown.less -->
                <li class="dropdown user user-menu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="fa fa-user"></i>
                        <span>My Account <i class="caret"></i></span>
                    </a>
                    <ul class="dropdown-menu dropdown-custom dropdown-menu-right">
                        <li class="dropdown-header text-center">Account</li>
                        <li class="divider"></li>
                        <li>
                            <a href="http://localhost:8080/pkm/html/login.html"><i class="fa fa-ban fa-fw pull-right"></i> Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
</header>

<aside class="left-side sidebar-offcanvas">
    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">
        <!-- Sidebar user panel -->
        <div class="user-panel">
            <div class="pull-left image">
                <img src="img/26115.jpg" class="img-circle" alt="User Image" />
            </div>
            <div class="pull-left info">
                <p>Hello</p>

                <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
            </div>
        </div>
        <!-- search form -->
        <div class="input-group sidebar-form">
            <input type="text" id="search-con" class="form-control" placeholder="Search..."/>
            <span class="input-group-btn">
                <button id='search-btn' class="btn btn-flat"><i class="fa fa-search"></i></button>
            </span>
        </div>
        <!-- /.search form -->
        <!-- sidebar menu: : style can be found in sidebar.less -->
        <ul class="sidebar-menu">
            <li>
                <a href="index.html" >
                    <i class="fa fa-dashboard"></i> <span>文件</span>
                </a>
            </li>
            <li class="active">
                <a href="pic.html">
                    <i class="fa fa-gavel"></i> <span>图片</span>
                </a>
            </li>

            <li>
                <a href="note.html">
                    <i class="fa fa-globe"></i> <span>笔记</span>
                </a>
            </li>

            <li>
                <a href="article.html">
                    <i class="fa fa-glass"></i> <span>我的文章</span>
                </a>
            </li>

            <li>
                <a href="search-article.html">
                    <i class="fa fa-glass"></i> <span>文章共享</span>
                </a>
            </li>

        </ul>
    </section>
</aside>

<!-- Right side column. Contains the navbar and content of the page -->
<aside class="right-side">
    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="panel">
                    <header class="panel-heading">
                        <button id='back' class="btn btn-sm btn-primary" >Back</button>
                    </header>
                    <!-- <div class="box-header"> -->
                    <!-- <h3 class="box-title">Responsive Hover Table</h3> -->
                    <!-- </div> -->
                    <div class="panel-body table-responsive">
                        <div class="box-tools m-b-15">
                            <nav class="navbar navbar-default" role="navigation">
                                <div class="container-fluid">
                                    <div class="navbar-header">
                                        <input type="text" id="foldername" class="form-control input-sm " style="width: 150px;" placeholder="新建文件夹名"/>
                                    </div>
                                    <button id='newfolderbtn' class="btn btn-sm btn-default navbar-left">新建文件夹</button>
                                    <form  id='upload' class="navbar-form navbar-left" role="form" enctype="multipart/form-data" >
                                        <div class="form-group">
                                            <input type="file"  name="file" accept="image/jpeg,image/png" id="file" />
                                        </div>
                                        <button id='upbtn' class="btn btn-sm btn-default" >上传</button>
                                    </form>
                                </div>
                            </nav>
                        </div>
                        <table id="table" class="table table-hover" style="table-layout:fixed">
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>操作</th>
                            </tr>
                        </table>
                    </div><!-- /.box-body -->
                </div><!-- /.box -->
            </div>
        </div>
    </section><!-- /.content -->
</aside><!-- /.right-side -->


<!-- jQuery -->
<script src="js/jquery.min.js" type="text/javascript"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<!-- Director App -->
<script src="js/Director/app.js" type="text/javascript"></script>

<script type="text/javascript">
    var json;
    var i=0;
    $(document).ready(function () {
        i=0;
        $.ajax({
            type: "POST",
            url: 'http://localhost:8080/pkm/pic',
            data:{},
            success: function (data) {
                json=data;
                var item;
                $.each(data, function(index, value) {
                    if(value['pid']==0){
                        item = "<tr ><td ondblclick=clickaction(this)>" + value['name'] + "</td><td>" + value['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id="+value['id']+">重命名</button></td></tr>";
                        $('.table').append(item);
                    }
                });
            }
        });
    });
    function clickaction(td){
        $.each(json, function (index, value) {
            if(value['name']==td.innerText && value['pid']==i){
                if(value['type']!='folder'){
                    window.open('http://localhost:8080/pkm/static/pic/'+value['id']+'.'+value['type'], '', 'width:50%;height:50%;top:100;left:100;');
                }
                else {
                    i=value['id'];
                    $('.table').html("<tr> <th>名称</th> <th>类型</th><th>操作 </th></tr>");
                    $.each(json, function (index, value) {
                        if(value['pid']==i){
                            var item;
                            item = "<tr ><td ondblclick=clickaction(this)>" + value['name'] + "</td><td>" + value['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id="+value['id']+">重命名</button></td></tr>";
                            $('.table').append(item);
                        }
                    });
                }
                return false;
            }
        });
    }
    $('#newfolderbtn').click(function (e) {
        if($('#foldername').val()==""){
            alert("请输入正确文件名")
            return false;
        }
        var ok=1;
        e.preventDefault();
        $('#table tr').each(function(i){                   // 遍历 tr
            $(this).children('td:first').each(function(j){  // 遍历 tr 的各个 td
                if($(this).text()==$('#foldername').val()){
                    alert("该目录已存在");
                    ok=0;
                    return false;
                }
            });
        });
        if(ok==1) {
            $.ajax({
                type: "POST",
                url: 'http://localhost:8080/pkm/newpic',
                contentType: "application/json",
                data: JSON.stringify({
                    "pid": i,
                    "name": $('#foldername').val(),
                    "type": 'folder'
                }),
                success: function (data) {
                    var item = "<tr><td ondblclick=clickaction(this)>" + data['name'] + "</td><td>" + data['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id=" + data['id'] + ">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id=" + data['id'] + ">重命名</button></td></tr>";
                    $('#table').append(item);
                    json.push(data)
                }
            });
        }
    });
    function deleclick(id){
        $.ajax({
            type: "POST",
            //async : false,
            url: 'http://localhost:8080/pkm/deletepic',
            contentType: "application/json",
            data: JSON.stringify({
                "id":id
            }),
            success: function (data) {
                var dname;
                $.each(json, function (index, value) {
                    if(value['id']==id){
                        json.splice(index,1);
                        dname=value['name'];
                        return false;
                    }
                });
                $('#table tr').each(function(i){                   // 遍历 tr
                    $(this).children('td:first').each(function(j){  // 遍历 tr 的各个 td
                        if($(this).text()==dname)
                            table.deleteRow(i);
                    });
                });
                alert("删除成功")
            }
        });
    }

    $('#upload').submit(function (e) {
        e.preventDefault();
        var file = $("#file").val();
        var strFileName=file.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");  //正则表达式获取文件名，不带后缀
        var FileExt=file.replace(/.+\./,"");//正则表达式获取后缀
        var ok=1;
        $('#table tr').each(function(i){                   // 遍历 tr
            $(this).children('td:first').each(function(j){  // 遍历 tr 的各个 td
                if($(this).text()==strFileName){
                    alert("当前目录包含重名文件");
                    ok=0;
                    return false;
                }
            });
        });
        if(ok==1) {
            var formdata=new FormData( );
            formdata.append("file" , $("#file")[0].files[0]);
            formdata.append("pid",i);
            formdata.append("name",strFileName);
            formdata.append("type",FileExt);
            $.ajax({
                url: 'http://localhost:8080/pkm/uploadpic',
                type: 'POST',
                cache: false,
                data: formdata,
                processData: false,
                contentType: false,
                success: function (data) {
                    var item = "<tr><td ondblclick=clickaction(this)>" + data['name'] + "</td><td>" + data['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id=" + data['id'] + ">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id=" + data['id'] + ">重命名</button></td></tr>";
                    $('#table').append(item);
                    json.push(data)
                },
            });
        }
    });
    function renameclick(id){
        var str=prompt();
        var tag=0;
        if(str){
            $.each(json, function (index, value) {
                if(value['id']!=id && value['pid']==i){
                    if(value['name']==str){
                        tag=1
                        alert("当前目录包含重名文件")
                        return false
                    }
                }
            });
        }
        if(str&&tag==0)
        {
            $.ajax({
                type: "POST",
                url: 'http://localhost:8080/pkm/renamepic',
                contentType: "application/json",
                data: JSON.stringify({
                    "id": id,
                    "name":str,
                }),
                success: function (data) {
                    var dname;
                    $.each(json, function (index, value) {
                        if(value['id']==id){
                            dname=value['name'];
                            value['name']=str;
                            return false;
                        }
                    });
                    $('#table tr').each(function(i){                   // 遍历 tr
                        $(this).children('td:first').each(function(j){  // 遍历 tr 的各个 td
                            if($(this).text()==dname)
                                $(this).text(str);
                        });
                    });
                }
            });
        }
    }

    $('#back').click(function () {
        $('.table').html("<tr> <th>名称</th> <th>类型</th><th>操作 </th></tr>");
        $.each(json, function (index, value) {
            if(value['id']==i){
                i=value['pid']
                return false;
            }
        });
        $.each(json, function (index, value) {
            if(value['pid']==i){
                var item;
                item = "<tr ><td ondblclick=clickaction(this)>" + value['name'] + "</td><td>" + value['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id="+value['id']+">重命名</button></td></tr>";
                $('.table').append(item);
            }
        });

    });
    $('#search-btn').click(function () {
        $(".panel-body").html("<p><table id=\"table\" class=\"table table-hover\" style=\"table-layout:fixed\"><tr><th>名称</th> <th>类型</th> <th>操作</th> </table> </p>");
        $.each(json, function (index, value) {
            if(value['name']==$('#search-con').val()&&value['type']!='folder'){
                var item;
                item = "<tr ><td id=\""+value['id']+"\" ondblclick=clickaction2(this.id)>" + value['name'] + "</td><td>" + value['type'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=renameclick(this.id) id="+value['id']+">重命名</button></td></tr>";
                $('.table').append(item);
            }
        });
    });
    function clickaction2(td){
        $.each(json, function (index, value) {
            if(value['id']==td){
                window.open('http://localhost:8080/pkm/static/pic/'+value['id']+'.'+value['type'], '', 'width:50%;height:50%;top:100;left:100;');
                return false;
            }
        });
    }
</script>



</body>
</html>