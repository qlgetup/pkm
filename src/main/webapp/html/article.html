<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Director | Dashboard</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <meta name="description" content="Developed By M Abdur Rokib Promy">
    <meta name="keywords" content="Admin, Bootstrap 3, Template, Theme, Responsive">
    <!-- bootstrap 3.0.2 -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <link href="css/ionicons.min.css" rel="stylesheet" type="text/css" />
    <!-- Morris chart -->
    <link href="css/morris/morris.css" rel="stylesheet" type="text/css" />
    <!-- jvectormap -->
    <link href="css/jvectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css" />
    <!-- Date Picker -->
    <link href="css/datepicker/datepicker3.css" rel="stylesheet" type="text/css" />
    <!-- fullCalendar -->
    <!-- <link href="css/fullcalendar/fullcalendar.css" rel="stylesheet" type="text/css" /> -->
    <!-- Daterange picker -->
    <link href="css/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css" />
    <!-- iCheck for checkboxes and radio inputs -->
    <link href="css/iCheck/all.css" rel="stylesheet" type="text/css" />
    <!-- bootstrap wysihtml5 - text editor -->
    <!-- <link href="css/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css" /> -->
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <!-- Theme style -->
    <link href="css/style.css" rel="stylesheet" type="text/css" />

</head>
<body class="skin-black">
<!-- header logo: style can be found in header.less -->
<header class="header">
    <a href="index.html" class="logo">
        <!-- Add the class icon to your logo image or logo icon to add the margining -->
        PKM
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top" role="navigation">
        <!-- Sidebar toggle button-->
        <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>
        <div class="navbar-right">
            <ul class="nav navbar-nav">
                <!-- User Account: style can be found in dropdown.less -->
                <li class="dropdown user user-menu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="fa fa-user"></i>
                        <span>My Account<i class="caret"></i></span>
                    </a>
                    <ul class="dropdown-menu dropdown-custom dropdown-menu-right">
                        <li class="dropdown-header text-center">Account</li>
                        <li class="divider"></li>
                        <li>
                            <a href="http://localhost:8080/pkm/html/login.html"><i class="fa fa-ban fa-fw pull-right"></i> Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
</header>

<aside class="left-side sidebar-offcanvas">
    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">
        <!-- Sidebar user panel -->
        <div class="user-panel">
            <div class="pull-left image">
                <img src="img/26115.jpg" class="img-circle" alt="User Image" />
            </div>
            <div class="pull-left info">
                <p>Hello</p>

                <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
            </div>
        </div>
        <!-- search form -->
        <div class="input-group sidebar-form">
            <input type="text" id="search-con" class="form-control" placeholder="Search..."/>
            <span class="input-group-btn">
                <button id='search-btn' class="btn btn-flat"><i class="fa fa-search"></i></button>
            </span>
        </div>
        <!-- /.search form -->
        <!-- sidebar menu: : style can be found in sidebar.less -->
        <ul class="sidebar-menu">
            <li>
                <a href="index.html" >
                    <i class="fa fa-dashboard"></i> <span>文件</span>
                </a>
            </li>
            <li>
                <a href="pic.html">
                    <i class="fa fa-gavel"></i> <span>图片</span>
                </a>
            </li>

            <li>
                <a href="note.html">
                    <i class="fa fa-globe"></i> <span>笔记</span>
                </a>
            </li>

            <li class="active">
                <a href="article.html">
                    <i class="fa fa-glass"></i> <span>我的文章</span>
                </a>
            </li>

            <li>
                <a href="search-article.html">
                    <i class="fa fa-glass"></i> <span>文章共享</span>
                </a>
            </li>

        </ul>
    </section>
</aside>

<!-- Right side column. Contains the navbar and content of the page -->
<aside class="right-side">
    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="panel">
                    <header class="panel-heading">
                        <button id='back' class="btn btn-sm btn-primary" >Back</button>
                    </header>
                    <!-- <div class="box-header"> -->
                    <!-- <h3 class="box-title">Responsive Hover Table</h3> -->
                    <!-- </div> -->
                    <div class="panel-body table-responsive">
                        <div class="box-tools m-b-15">
                            <div class="input-group">
                                <button id='newarticlebtn' class="btn btn-sm btn-warning"  onclick=newarticle() >写文章</button>
                            </div>
                        </div>
                        <table id="table" class="table table-hover" style="table-layout:fixed">
                            <tr>
                                <th>名称</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </table>
                    </div><!-- /.box-body -->
                </div><!-- /.box -->
            </div>
        </div>
    </section><!-- /.content -->
</aside><!-- /.right-side -->


<!-- jQuery -->
<script src="js/jquery.min.js" type="text/javascript"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<!-- Director App -->
<script src="js/Director/app.js" type="text/javascript"></script>

<script type="text/javascript">
    var json;
    $(document).ready(function () {
        $.ajax({
            type: "POST",
            url: 'http://localhost:8080/pkm/article',
            data:{},
            success: function (data) {
                json=data;
                var item;
                $.each(data, function(index, value) {
                    item = "<tr ><td id=\""+value['id']+"\" ondblclick=clickaction(this)>" + value['name'] + "</td><td>" + value['time'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=editarticle(this) id="+value['id']+">编辑</button></td></tr>";
                    $('.table').append(item);
                });
            }
        });
    });
    function editarticle(td){
        $.each(json, function (index, value) {
            if(value['id']==td.id){
                $(".panel-body").html("<p>" +
                    "<input type=\"text\" id=\"name\" value=\""+value['name']+"\"/>\n"+
                    "<p><iframe id=\"editor\"  width=\"1000px\" height=\"380px\" style=\"border:solid 1px;\"></iframe></p>\n" +
                    "<input type=\"button\" id=\"save\" class='btn btn-sm btn-default' value=\"保存\" />\n" +
                    "<input type=\"button\" id=\"cancel\" class='btn btn-sm btn-default' onclick=cancel() value=\"取消\" />\n" +
                    "</p>");
                    $d = $("#editor")[0].contentWindow.document; // IE、FF都兼容
                    $d.designMode="on";
                    $d.contentEditable= true;
                    $d.open();
                    $d.close();
                    $("body", $d).append(value['content']);
                    $('#save').click(function(){
                        if(!$('#name').val()){
                            alert("请输入标题");
                            return false;
                        }
                        var tag=0;
                        $.each(json, function (index, value) {
                                if(value['name']==$('#name').val()&&value['id']!=td.id){
                                    tag=1
                                    return false
                                }
                        });
                        if(tag==1) {
                            alert("换个标题吧，当前目录已存在该标题")
                            return false;
                        }
                        // 获取iframe的body内容，用于显示或者插入到数据库
                        var con=$('#editor').contents().find('body').html();
                        $.ajax({
                            type: "POST",
                            url: 'http://localhost:8080/pkm/updatearticle',
                            contentType: "application/json",
                            data:JSON.stringify({
                                "id":value['id'],
                                "name":$('#name').val(),
                                "content":con,
                            }),
                            success: function (data) {
                                $.each(json, function (index, value) {
                                    if(value['id']==data['id']){
                                        value['name']=data['name'];
                                        value['content']=data['content'];
                                        value['time']=data['time'];
                                        return false;
                                    }
                                });
                                alert("保存成功");
                                cancel();
                            }
                        });
                    });
                return false;
            }
        });
    }

    function deleclick(id){
        $.ajax({
            type: "POST",
            //async : false,
            url: 'http://localhost:8080/pkm/deletearticle',
            contentType: "application/json",
            data: JSON.stringify({
                "id":id
            }),
            success: function (data) {
                var dname;
                $.each(json, function (index, value) {
                    if(value['id']==id){
                        json.splice(index,1);
                        dname=value['name'];
                        return false;
                    }
                });
                $('#table tr').each(function(i){                   // 遍历 tr
                    $(this).children('td:first').each(function(j){  // 遍历 tr 的各个 td
                        if($(this).text()==dname)
                            table.deleteRow(i);
                    });
                });
                alert("删除成功")
            }
        });
    }

    function cancel() {
        $(".panel-body").html(" <div class=\"box-tools m-b-15\">\n" +
            "<div class=\"input-group\">\n" +
            "<button id='newarticlebtn' class=\"btn btn-sm btn-warning\"  onclick=newarticle() >写文章</button>\n" +
            "</div>\n" +
            "</div>\n" +
            "<table id=\"table\" class=\"table table-hover\" style=\"table-layout:fixed\">\n" +
            "<tr>\n" +
            "<th>名称</th>\n" +
            "<th>修改时间</th>\n" +
            "<th>操作</th>\n" +
            "</table>");
        $.each(json, function(index, value) {
            var item = "<tr ><td id=\""+value['id']+"\" ondblclick=clickaction(this)>" + value['name'] + "</td><td>" + value['time'] + "</td><td><button class=\"btn btn-sm btn-danger\" onclick=deleclick(this.id) id="+value['id']+">删除</button> <button class=\"btn btn-sm btn-success\" onclick=editarticle(this) id="+value['id']+">编辑</button></td></tr>";
            $('.table').append(item);
        });
    }
    function newarticle(){
        $(".panel-body").html("<p>" +
            "<input type=\"text\" id=\"name\" placeholder=\"请输入标题\"/>\n"+
            "<p><iframe id=\"editor\" width=\"1000px\" height=\"380px\" style=\"border:solid 1px;\"></iframe></p>\n" +
            "<input type=\"button\" id=\"save\" class='btn btn-sm btn-default' value=\"保存\" />\n" +
            "<input type=\"button\" id=\"cancel\" class='btn btn-sm btn-default' onclick=cancel() value=\"取消\" />\n" +
            "</p>");
        $d = $("#editor")[0].contentWindow.document; // IE、FF都兼容
        $d.designMode="on";
        $d.contentEditable= true;
        $d.open();
        $d.close();
        $('#save').click(function(){
            if(!$('#name').val()){
                alert("请输入标题");
                return false;
            }
            var tag=0;
            $.each(json, function (index, value) {
                    if(value['name']==$('#name').val()){
                        tag=1
                        return false
                    }
            });
            if(tag==1) {
                alert("换个标题吧，当前目录已存在该标题")
                return false;
            }
            // 获取iframe的body内容，用于显示或者插入到数据库
            var con=$('#editor').contents().find('body').html();
            $.ajax({
                type: "POST",
                url: 'http://localhost:8080/pkm/newarticle',
                contentType: "application/json",
                data:JSON.stringify({
                    "name":$('#name').val(),
                    "content":con,
                }),
                success: function (data) {
                    json.push(data);
                    alert("保存成功");
                    cancel();
                }
            });
        });
    }
    function clickaction(td){
        $.each(json, function (index, value) {
            if (value['id'] == td.id) {
                $(".panel-body").html("<div align='center' style=\"color:#00FF00\"><h3>" +
                    value['name'] +
                    "</h3></div>" +
                    "<div align='center'><iframe width=\"1000px\" height=\"400px\" frameborder='0' srcdoc='"+ value['content']+
                    "'></iframe></div>");
                return false;
            }
        });
    }
    $('#back').click(function () {
        cancel();
    });
</script>


</body>
</html>